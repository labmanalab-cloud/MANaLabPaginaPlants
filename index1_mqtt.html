<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Sensors Advance Laboratory</title>
<script src="https://cdn.jsdelivr.net/npm/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css" rel="stylesheet">
<style>
body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
header { text-align: center; margin-bottom: 20px; background: #e0e0e0; padding: 15px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
header h1 { margin: 0; font-size: 28px; display: flex; justify-content: center; align-items: center; gap: 10px; color: #1a3d7c; }
header h1 i { color: #1a3d7c; }
header #fecha { font-size:16px; margin-top:5px; color:#333; }
.tab-container { display: flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
.tab { padding:10px 15px; background:#e0e0e0; border-radius:5px; cursor:pointer; font-weight:bold; color:#333; }
.tab.active { background:#1e88e5; color:white; }
.tab-content { display:none; }
.tab-content.active { display:block; }
.sensor-container { display:flex; gap:20px; margin-bottom:30px; flex-wrap:wrap; }
.panel { border:1px solid #ccc; padding:15px; border-radius:10px; flex:1; background:#fff; box-shadow:0 1px 4px rgba(0,0,0,0.1); min-width:250px; }
.subtitulo { font-size:20px; font-weight:bold; text-decoration:underline; margin:10px 0; color:#1a3d7c; display:flex; align-items:center; gap:5px; }
.valor { font-size:16px; margin:5px 0; }
button { padding:10px; margin:5px 0; border:none; background:#1e88e5; color:white; border-radius:5px; cursor:pointer; width:100%; }
button:hover { background:#1565c0; }
</style>
</head>
<body>
<header>
<h1><i class="ri-windy-line"></i> Sensors Advance Laboratory</h1>
<div id="fecha">Fecha: --</div>
</header>

<div class="tab-container">
  <div class="tab active" data-target="esp1">Invernadero 1</div>
  <div class="tab" data-target="esp2">Invernadero 2</div>
  <div class="tab" data-target="esp3">Invernadero 3</div>
  <div class="tab" data-target="esp4">Invernadero 4</div>
</div>

<div id="esp1" class="tab-content active"></div>
<div id="esp2" class="tab-content"></div>
<div id="esp3" class="tab-content"></div>
<div id="esp4" class="tab-content"></div>

<script>
function actualizarFecha(){
  const now = new Date();
  document.getElementById('fecha').textContent = `Fecha: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
}
setInterval(actualizarFecha,1000);
actualizarFecha();

const ESPs = {
  esp1:{ clientId:"ESP32_Planta1", sensores:{
    1:{nombre:"Sensor 1", topic:"sensor/plantas/1", datos:[], grafica:"grafica_esp1_1", status:"status_esp1_1"},
    2:{nombre:"Sensor 2", topic:"sensor/plantas/2", datos:[], grafica:"grafica_esp1_2", status:"status_esp1_2"},
    3:{nombre:"Sensor 3", topic:"sensor/plantas/3", datos:[], grafica:"grafica_esp1_3", status:"status_esp1_3"},
    4:{nombre:"Sensor 4", topic:"sensor/plantas/4", datos:[], grafica:"grafica_esp1_4", status:"status_esp1_4"},
    5:{nombre:"Sensor 5", topic:"sensor/plantas/5", datos:[], grafica:"grafica_esp1_5", status:"status_esp1_5"}
  }},
  esp2:{ clientId:"ESP32_Planta2", sensores:{
    1:{nombre:"Sensor 1", topic:"sensor/plantas/6", datos:[], grafica:"grafica_esp2_1", status:"status_esp2_1"},
    2:{nombre:"Sensor 2", topic:"sensor/plantas/7", datos:[], grafica:"grafica_esp2_2", status:"status_esp2_2"},
    3:{nombre:"Sensor 3", topic:"sensor/plantas/8", datos:[], grafica:"grafica_esp2_3", status:"status_esp2_3"},
    4:{nombre:"Sensor 4", topic:"sensor/plantas/9", datos:[], grafica:"grafica_esp2_4", status:"status_esp2_4"},
    5:{nombre:"Sensor 5", topic:"sensor/plantas/10", datos:[], grafica:"grafica_esp2_5", status:"status_esp2_5"}
  }},
  esp3:{ clientId:"ESP32_Planta3", sensores:{
    1:{nombre:"Sensor 1", topic:"sensor/plantas/11", datos:[], grafica:"grafica_esp3_1", status:"status_esp3_1"},
    2:{nombre:"Sensor 2", topic:"sensor/plantas/12", datos:[], grafica:"grafica_esp3_2", status:"status_esp3_2"},
    3:{nombre:"Sensor 3", topic:"sensor/plantas/13", datos:[], grafica:"grafica_esp3_3", status:"status_esp3_3"},
    4:{nombre:"Sensor 4", topic:"sensor/plantas/14", datos:[], grafica:"grafica_esp3_4", status:"status_esp3_4"},
    5:{nombre:"Sensor 5", topic:"sensor/plantas/15", datos:[], grafica:"grafica_esp3_5", status:"status_esp3_5"}
  }},
  esp4:{ clientId:"ESP32_Planta4", sensores:{
    1:{nombre:"Sensor 1", topic:"sensor/plantas/16", datos:[], grafica:"grafica_esp4_1", status:"status_esp4_1"},
    2:{nombre:"Sensor 2", topic:"sensor/plantas/17", datos:[], grafica:"grafica_esp4_2", status:"status_esp4_2"},
    3:{nombre:"Sensor 3", topic:"sensor/plantas/18", datos:[], grafica:"grafica_esp4_3", status:"status_esp4_3"},
    4:{nombre:"Sensor 4", topic:"sensor/plantas/19", datos:[], grafica:"grafica_esp4_4", status:"status_esp4_4"},
    5:{nombre:"Sensor 5", topic:"sensor/plantas/20", datos:[], grafica:"grafica_esp4_5", status:"status_esp4_5"}
  }},
};

// ------------------ GENERAR BLOQUES ------------------
Object.keys(ESPs).forEach(espKey=>{
  const espDiv = document.getElementById(espKey);
  const esp = ESPs[espKey];
  
  espDiv.innerHTML = `<div style="margin-bottom:10px;font-weight:bold;">Cliente MQTT: <span id="status_${espKey}">Conectando...</span></div>`;
  
  Object.keys(esp.sensores).forEach(sId=>{
    const s = esp.sensores[sId];
    espDiv.innerHTML += `
      <div class="subtitulo"><i class="ri-leaf-line"></i>${s.nombre}</div>
      <div class="sensor-container">
        <div class="panel">
          <div class="valor">VD (V): <span id="VD_${espKey}_${sId}">--</span></div>
          <div class="valor">Rx (Ω): <span id="Rx_${espKey}_${sId}">--</span></div>
          <div class="valor">Tiempo sensado: <span id="Tiempo_${espKey}_${sId}">0h 0m 0s</span></div>
          <button onclick="descargarExcel('${espKey}',${sId})">⬇ Descargar Excel (datos desde apertura)</button>
          <div>Estado sensor: <span id="${s.status}">Desconectado ❌</span></div>
        </div>
        <div class="panel" style="flex:2">
          <canvas id="${s.grafica}"></canvas>
        </div>
      </div>
    `;
  });
});

// ------------------ INICIALIZAR GRÁFICAS ------------------
Object.keys(ESPs).forEach(espKey=>{
  const esp = ESPs[espKey];
  Object.keys(esp.sensores).forEach(sId=>{
    const s = esp.sensores[sId];
    const ctx = document.getElementById(s.grafica).getContext('2d');
    s.graficaObj = new Chart(ctx,{
      type:'line',
      data:{ labels:[], datasets:[{ label: s.nombre + ' VD vs Tiempo', data:[], borderColor:'blue', fill:false }] },
      options:{ responsive:true, scales:{ x:{ title:{ display:true, text:"Tiempo (s)" } }, y:{ title:{ display:true, text:"VD (V)" } } } }
    });
  });
});

// ------------------ CONEXIÓN MQTT ------------------
Object.keys(ESPs).forEach(espKey=>{
  const esp = ESPs[espKey];
  esp.client = mqtt.connect("wss://broker.emqx.io:8084/mqtt",{ clientId: esp.clientId, keepalive:60, reconnectPeriod:3000 });

  esp.client.on("connect", ()=>{
    document.getElementById(`status_${espKey}`).textContent="Conectado ✅";
    Object.values(esp.sensores).forEach(s=>{
      esp.client.subscribe(s.topic, err=>{
        document.getElementById(s.status).textContent = err ? "Error ❌" : "Suscrito ✅";
      });
    });
  });

  esp.client.on("message",(topic,message)=>{
    try{
      const data = JSON.parse(message.toString());
      Object.keys(esp.sensores).forEach(sId=>{
        const s = esp.sensores[sId];
        if(s.topic===topic){
          s.datos.push([data.tiempo,data.VD,data.Rx]);

          document.getElementById(`VD_${espKey}_${sId}`).textContent=data.VD;
          document.getElementById(`Rx_${espKey}_${sId}`).textContent=data.Rx;

          // Tiempo total sensado en horas, min y seg
          const totalSeg = s.datos.length * 3; // cada dato representa 3s
          const h = Math.floor(totalSeg/3600);
          const m = Math.floor((totalSeg%3600)/60);
          const sRest = totalSeg%60;
          document.getElementById(`Tiempo_${espKey}_${sId}`).textContent=`${h}h ${m}m ${sRest}s`;

          if(!s.ultimoTiempoGrafica) s.ultimoTiempoGrafica=0;
          if(data.tiempo - s.ultimoTiempoGrafica >=3){
            s.graficaObj.data.labels.push(data.tiempo);
            s.graficaObj.data.datasets[0].data.push(data.VD);
            if(s.graficaObj.data.labels.length>50){
              s.graficaObj.data.labels.shift();
              s.graficaObj.data.datasets[0].data.shift();
            }
            s.graficaObj.update();
            s.ultimoTiempoGrafica = data.tiempo;
          }
        }
      });
    }catch(e){ console.error(e); }
  });
});

// ------------------ DESCARGA ------------------
function descargarExcel(espKey,sId){
  const s = ESPs[espKey].sensores[sId];
  let ws = XLSX.utils.aoa_to_sheet([["Tiempo (s)","VD (V)","Rx (Ω)"],...s.datos]);
  let wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Datos "+s.nombre);
  XLSX.writeFile(wb,`datos_${espKey}_sensor${sId}.xlsx`);
}

// ------------------ PESTAÑAS ------------------
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.target).classList.add("active");
  });
});
</script>
</body>
</html>
